# 코드 리뷰

> 2022년 4월 우아한테크세미나
>
> https://www.youtube.com/watch?v=ssDMIcPBqUE



## 왜 코드 리뷰를 해야 하나?

### 우리가 살고 있는 시대

“Software is eating the world”

변동성의 시대

Satya Nadell - Build 2021

- Global GDP : Tech => 2020: 5%, 2030: 10%
- Non-Tech 영역에서 개발자 수 증가속도가 Tech 영역에서보다 가파름(지난 2년간)

DRFR: Deliver SW Rapidly, Frequently and more Reliably



### 출시별 생산성

더 많은 인력과 자원에도 불구하고 출시가 늘어날수록 생산성은 낮아짐

- 기존의 코드를 파악하는 시간이 새로운 기능을 개발하는 시간보다 길어짐



### 개발 생산성





### SW 공학의 특성 

공학 = 설계 + 빌드

- 설계: 예측하기 어렵기에 급여가 비싸고 창의적인 사람들을 필요
- 빌드: 좀 더 예측하기 쉬움

건축 => 설계와 빌드가 분리됨, 빌드 비용이 90%

SW => { 

​	설계 = 소스 코드, 빌드 = 컴파일

​	건축 분야보다 설계가 중요

​	좋은 설계 ~= 클린코드

}

클린 코드의 중요성

- SW의 진정한 비용 ~= 유지보수(80% 이상)
- 한번 작성한 코드는 10번 이상 읽힘. 작성보다 이해에 10배의 노력 소요
- 90% 이상의 시간을 어떤 코드를 이해하는 데 사용함

SW 개발의 단순한 진리

- The only way to go fast, is to go well
- 시간이 흘러도 생산성 저하, 비용 증가를 막을 수 있는 유일한 방법
- SW 품질에 신중해야
  - SW의 비용과 품질의 관계는 비정상, 비직관적
    - 높은 품질의 제품은 비싸다 - 유지보수 비용이 높기에 잘 설계된 코드가 오히려 비용이 낮을 수 있음



### SW 장인정신

공유 활동 => 발전

코드 리뷰

- 개발자가 지금부터 당장 행할 수 있는 공유 활동
- Code SNS 댓글 놀이
- 배움을 주고 받으며 지속가능한 SW 개발자가 될 수 있는 실천법



### 목적

주 목적: 품질 문제 검수

더 나은 코드 품질: 아키텍처 속성 개선을 위한 코드 개선(추후 변경 비용 감소)

학습 및 지식 전달: 코드, 해결책 등과 관련된 지식 공유에 기여

- 공유를 통한 역량 증대 및 성장
  - 대개의 경우 리뷰어들도 리뷰 과정에서 지식을 얻게 됨(소프트 스킬: 커뮤니케이션, 리더십)
- 동기부여

상호 책임감 증대

- 집단 코드 오너십 및 결속 증대
- 내가 하고 있는 일에 관심을 가져주는 것
- 팀에서 일어나는 일 공유. 내 동료는 무엇을 하나? - 팀워크

설계 개선 제안

개발 문화 개선



## 코드 리뷰 절차

저자

- 코드 작성, 리뷰 요청 (PR)

리뷰어

- 코드를 읽고
- 머지 가능한지 결정



좋은 Pull Request 예

- 테스트 하는 방법, 커밋 내용 등 최대한 읽는 사람을 배려하여 리뷰어의 시간을 아껴주어야 함



### 왜 코드 리뷰가 어려운가?

저자

- 본인 생각에 멋지다고 생각하는 PR을 보냄

리뷰어

- 왜 멋지지 않은지에 대한 장황한 이유를 작성

In aviation, for example, people who greatly overestimate their level of skills are all dead

코드에 대한 비판을 자신에 대한 비판으로 이해



코드 리뷰는

- 지식 / 공학적 결정을 공유하는 기회
- 공유를 통해 서로의 지식/경험을 나누며 상호 학습을 통한 역량 증대 수단
- 코드 토의를 개인적 공격으로 받아들이면 물거품

생각을 글로 전달하는 것에 대한 어려움

- 오해소지

피드백을 조심스럽게 표현하는 것이 더 중요



## 기법들

### 효율적인 코드 리뷰 방법

#### PR

지루한 작업은 컴퓨터로 처리

스타일 가이드를 통해 스타일 논쟁을 해소

PR을 올릴 때 주석 달기

- 리뷰어들에게 도움이 많이 됨

모두를 포함하라

의미있는 커밋으로 분리

- 리뷰가 필요한지?



코드를 읽는 것은 인지적 부담이 되는 고수준의 집중이 요구되는 작업

- 컴퓨터가 할 수 있는 일에 이런 노력을 낭비하지 말라
- 심지어 기계가 더 잘 할 수 있는 일에 (unused import 같은)

Formatting Tool

- 공백, 들여쓰기 오류 등
- 별도의 커밋/PR로 분리. (리뷰 불필요) 를 기술하여 리뷰를 생략할 수 있도록

스타일에 대한 논쟁은 리뷰에서 시간 낭비



많은 사람들이 볼 수록 버그를 더 잘 찾아낼 수 있다

많은 사람들이 본다는 것을 알면 사람들은 대개 더 잘하려는 경향이 있다



혼자하는 코드 리뷰

- 잘게 나눠진 커밋을 통해 PR을 의미있게



#### 리뷰

코드 리뷰를 높은 우선순위로

- 저자는 리뷰 종료될 때까지 대기Blocked함

리뷰를 바로 시작하는 선순환

- 잘 읽히기 위한 PR

리뷰 라운드의 최대 시간은 하루

- 1일 이내 진행 불가하다면 다른 리뷰어 지정
- 한달내 두번 이상 리뷰어 재지정 필요시 개발습관 개선



### 리뷰는 즉시 시작

매일 아침 30분, 점심 식사후 30분을 리뷰를 위해 미리 확보

PR에 포함된 변경이 적도록 노력

- 반나절 정도 작업한 양 정도
- 모든 팀원들이 하루에 두번 작은 양의 PR을 리뷰할 수 있고 최대 4시간 안에 리뷰가 완료될 것

근본적인 문제는 사람들이 리뷰할 시간이 없다고 느낀다는 것

- 개인 기여로만 평가를 받고 있다면, 팀을 돕기 위해 수행하는 모든 일은 시간 낭비처럼 보임
- 이것은 리뷰를 하는 것의 문제라기 보다는 조직 차원의 문제



Pull Requests vs. Pair Programming

- Latency와 throughput의 트레이드오프
- 팀원들의 내향, 외향적 성향 등 상황을 고려하여 하나를 선택하거나 섞어서 사용하는 등의 선택 가능



리뷰 라운드에서 많은 의견을 남길 수록 저자가 당황할 위험이 커짐

하나의 라운드에 20~50개 정도의 의견은 위험의 시작

초기 라운드에서는 고수준 피드백으로 제한

- 버그, 장애, 성능, 보안 등

고수준의 피드백 후 저수준 이슈 처리

- 설계 개선, 변수명 변경, 명확한 주석 등



### 예제 코드 제공에 관대하라

저자를 기분 좋게 하기 위한 방법

- 리뷰 중에 선물 주기(예제 코드)

너무 긴 예제는 관대한 것이 아니라 억압적으로 보임

라운드당 2~3개의 코드 예제로 제한

- 모든 PR에 예제를 제공하면 저자가 코드를 작성할 수 없다고 생각하는 것처럼 보일 수 있음



PR에 포함되지 않은 라인은 코드 리뷰 대상이 아니나, 주변에 영향을 주는 경우 대상이 될 수도 있음



[Nit]

- 고치면 좋지만 아니어도 그만
- 리뷰어는 항상 더 개선할 수 있는 의견을 자유롭게 남길 수 있어야
- 중요치 않다면 Nit 태그로 남겨 무시할 수도 있도록 할 수 있음
- 교육적인 목적을 가지고 지속적으로 기술을 연마하는 것을 돕고자



### 한두 등급만 코드 레벨을 올리는 것을 목표로

D 등급의 PR(퀄리티가 좋지 않은 코드)를 받으면 저자가 C나 B 등급을 받도록 도와라

- Letter Grade

완전하지는 않아도 충분히 좋은 코드가 되도록

F

- 기능적으로 틀렸거나
- 너무 복잡해서 정합성에 확신이 없는 상태
- 몇 번의 라운드 이후에도 F인 경우에는 승인 보류 가능



### 피드백 방법

#### 절대 “너” 라고 하지 마라

리뷰의 핵심

- 무엇이 코드를 나아지게 하는가
- 누가 잘못을 했는지가 아님

저자의 방어 유발을 최소화하는 방법으로 피드백

- 오타의 경우: sucessfully => successfully 같은 느낌

- 비판의 대상은 코드

~하는 게 어떨까요?



#### 건설적인 피드백을 하라

동료들 간의 코드 리뷰

- 경쟁 유발이 아닌 팀의 생산성을 높이는 것

코드 리뷰를 비판이 아니라 학습의 과정으로 인지하면 전체적인 프로젝트의 성공에 기여함

건설적인 피드백은 개발자들이 그들의 실수에서 배우고 역량을 증대하도록 동기부여함

건설적인 피드백을 못하겠으면 차라리 침묵하는 것이 낫다



#### 진정한 칭찬을 하라

대부분의 리뷰어가 잘못된 부분에만 집중

- 하지만 리뷰는 긍정적 행위 강화를 위한 값진 기회이기도 함

PR에서 좋은 변경이 있을 때마다

- 좋은 생각이에요 등

저자가 주니어 혹은 신규 입사자라면 리뷰에 매우 민감하고 방어적일 수 있음

진심어린 칭찬은 리뷰어가 잔인한 감시자가 아니라 도와주려는 팀동료라는 것을 보여줄 수 있음



### 명령이 아니라 요청으로 표현하라

일상에서 동료에게 명령하지 않음

하지만 리뷰에서는 강압적인 명령이 종종 발견됨

- ~할 수 있을까요?, ~해지는데 괜찮을까요?(스스로 문제를 찾을 수 있도록)



#### 의견이 아니라 원칙에 기반하여 피드백하라

저자에게 의견을 줄 때는

- 제안점과 이유를 모두 설명하라

SW는 과학인 동시에 예술

- 항상 원칙에 기반하여 언급할 수 있지 않다
- 보기 싫거나 직관적이지 않을 수 있다
- 무엇을 할 수 있을지 객관적으로 설명하라
  - 이 코드는 혼란스럽네요 => 어떡하라는 건지 잘 모를 수 있음



#### 반복적인 패턴에 대해서 피드백을 제한하라

저자의 실수가 동일한 패턴임을 식별했다면 모든 경우를 언급하지는 말라

동일 패턴에 대해서 2~3개 정도의 예를 언급하라

그 이상은 저자에게 개별 사례가 아닌 패턴의 수정을 요청



### 교착상태

교착상태를 나타내는 표식

- 토론의 톤이 팽팽해지고 공격적이 됨
- 라운드당 커멘트가 줄어들지 않는 경향
- 나무 많은 커멘트에 저항이 보임

코드 리뷰의 최악의 결과는 교착상태

- 커멘트를 반영하지 않아 승인 거부
- 저자는 커멘트 반영을 거부

만나서 얘기하라

- 화상 또는 만나서 논의
- 텍스트 기반 의사소통은 상대가 인간이라는 것을 잊게 할 수 있음



인정하거나 Escalate 하라

- 교착상태가 길어지면 관계가 나빠짐
- 그냥 승인하는 비용 Agree to disagree
- 저수준 코드를 무심코 승인하면 SW품질이 나빠지지만, 함계 일하지 않게 된다면 고수준의 품질을 얻을 기회가 사라짐



설계 리뷰를 고려하라

- 코드 리뷰 때 설계 리뷰 때 논의되었어야 할 사항을 논쟁하는가?
- 설계 리뷰는 있었나?

아주 심각하지 않다면

- 그냥 인정하고 좋은 관계로 동료와의 협업을 지속해라
- Agree to disagree



### 코드 리뷰를 하는 아주 재밌는 방법

PR을 작성한 사람과 짝 프로그래밍을 하며 어떻게 고치는 게 좋은지 보여주고,

Revert

PR을 작성한 사람이 스스로 개선할 수 있도록 기회를 주는

- 20분 짝 프로그래밍을 통해 개선한 내용을 2시간이 걸려 스스로 개선해야 할 수도
- 하지만 덕분에 스스로 하는 법을 배울 수 있음



결정은 저자가

- 완벽한 설계가 아니라 당신이 할 수 있는 최고의 설계를 추구 - Letter Grade에는 B C D 존재
- 팀 정신을 유지하기 위해 불완전한 해결책을 받아들여라
- 모든 설계 결함이 항상 실제로 문제가 되지는 않음

코드 리뷰의 목적은 비난이 아니라 배움이다

- 종종 리뷰어들도 배우게 됨

리뷰하려는 코드가 그냥 나쁠 때도 있음

- 저자가 그날 무슨 일이 있을 수도
- 신규 입사자, 경험이 부족한 팀원의 코드를 리뷰하며 이런 상황을 만났을 때는 조금 더 안내하는 마음으로



#### Appendix

저자의 노력

- 리뷰어 n명의 시간을 절약
- 효과적인 리뷰

리더의 관심과 의지

- 가끔, 그러나 매우 자세히

코드 비난에 대한 두려움 해소

- 내가 실수하더라도 동료가 도와줄 수 있음

멋져 보여야

- 그게 무엇이 되었든 따라 하고 싶어질 만큼 멋있어야 함

- 지각하지 말고, 업무에 기여하고, 긍정적으로 임하고, 사람들을 잘 대하라
- 키보드로 코딩을 할 때 사람들이 경악을 하도록 하라
- 당신이 엄청난 모습을 보여주면 아마도 몇몇 사람들에게는 영감을 줄 수도 있을 것이다



##### 코드 리뷰의 효과

예상하지 못한 버그를 타 프로젝트에서 바력ㄴ하기도

시간이 지나니 선플이 달리기 시작

많은 사람이 내가 작성한 코드를 본다는 생각에 한번 더 코드를 다듬게 됨

좋은 설계, 아키텍처, 클린코드, TDD 등에 대한 공감대/열정 형성

- 잘하는 동료를 보면 잘하려는 열정이 생김



### 코드리뷰를 잘 하기 위해 필요한 기술들

#### 리팩터링

결과의 변경 없이 코드의 구조를 재조정

- 주로 가독성을 높이고 유지보수를 편하게
- 버그를 없애거나 새로운 기능을 추가하는 행위는 아님

TDD와 연결된 리팩터링

- 돌아가는 코드를 가지고 설계를 하는 행위
- 그린필드 프로젝트에서 아무것도 없는 상태에서 분석/설계부터 시작하는 비율

코드리뷰에서 많이 언급하는 기술적 내용

매일 리팩터링

- Continuous Renaming
- Composed Method(Extract Method)
- 응집도 높이기
- Discover Value Object

#### Legacy Code 다루기

의존성 관리, 테스트 추가, 새로운 코드 빠르게 추가, 레거시 분석



#### Clean Code & TDD

TDD

- 전통파 and 런던파
- Outside in -> Inside out



### FAQ

코드리뷰 자체가 중요할까?

- 공유와 코드에 대한 논의를 할 수 있는 문화가 중요

개발 생산성 vs 개발 품질의 트레이드오프

- 버그 수정 비용은 개발 라이프사이클 후반으로 갈수록 기하급수적으로 커짐
- 품질이 높으면 라이프사이클의 후반으로 갈수록 시간이 절약됨
- 따라서 TDD, Test, Refactoring, Code Review 등은 생산성을 증대시킴
- 거기다 높은 품질은 “향후 추가 비용”을 감소시킴

너무 기법/절차에 의지하지 말라

- 사람 눈에 잘 읽히는 코드인지가 중요

일정, 우선 순위

- 시간을 아끼는 가장 좋은 방법 = 저자의 노력

주기: 짧게 자주 - 그러니 PR은 사이즈를 작게 해야 함

꾸준히 리뷰를 진행해도 조기에 발견될 수 있는 오류가 추후에 장애로 돌아오는 사례가 빈번히 발생

- 수학이 아니라 과학

상사를 어떻게 설득하나?

- 비즈니스 지표 등 수치
- 의사결정권자에게 중요한 것을 이해 & 신뢰 구축

